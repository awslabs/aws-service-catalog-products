# Copyright 2021 Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

Schema: factory-2019-04-01
Portfolios:
  Components:
    - Name: cdk-support-iam
      Owner: central-it@customer.com
      Description: run a cdk bootstrap within a given region of a given account
      Distributor: central-it-team
      SupportDescription: Contact us on Chime for help #central-it-team
      SupportEmail: central-it-team@customer.com
      SupportUrl: https://wiki.customer.com/central-it-team/self-service/cdk-support/bootstrap
      Tags:
        - Key: product-type
          Value: app-dev
      Versions:
        - Name: v2
          Description: Runs a CDK bootstrap in a given region of a given account
          Source:
            Provider: CodeCommit
            Configuration:
              RepositoryName: cdk-support-iam
              BranchName: v2

    - Name: cdk-support-bootstrap
      Owner: central-it@customer.com
      Description: run a cdk bootstrap within a given region of a given account
      Distributor: central-it-team
      SupportDescription: Contact us on Chime for help #central-it-team
      SupportEmail: central-it-team@customer.com
      SupportUrl: https://wiki.customer.com/central-it-team/self-service/cdk-support/bootstrap
      Tags:
        - Key: product-type
          Value: app-dev
      Versions:
        - Name: v4
          Description: Runs a CDK bootstrap in a given region of a given account
          Source:
            Provider: CodeCommit
            Configuration:
              RepositoryName: cdk-support-bootstrap
              BranchName: v4
          Stages:
            Package:
              BuildSpec: |
                version: 0.2
                phases:
                  install:
                    runtime-versions:
                      python: 3.9
                  build:
                    commands:
                      - pip install -r start_cdk_deploy/requirements.txt -t start_cdk_deploy/src
                    {% for region in ALL_REGIONS %}
                      - aws cloudformation package --template $(pwd)/product.template.yaml --s3-bucket sc-factory-artifacts-${ACCOUNT_ID}-{{ region }} --s3-prefix ${STACK_NAME} --output-template-file product.template-{{ region }}.yaml
                    {% endfor %}
                artifacts:
                  files:
                    - '*'
                    - '**/*'
